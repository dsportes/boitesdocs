<!DOCTYPE html><html><head><title> DonnÇes </title><meta charset='utf-8'><style> 
#content, body {
    -webkit-text-size-adjust: 100%; text-size-adjust: 100%; color: black;
    font-family: "Ubuntu"; font-size: 1rem; line-height: 1.3;
    word-wrap: break-word;
    padding: 1rem; max-width:800px; margin:0 auto;
    background: white;
}
h1,h2,h3,h4,h5,h6 { font-family:"Calibri"; line-height: 1.2; color:#37474F;padding-top:0.2rem;padding-bottom:0.2rem;}
h1 { font-size:2rem; font-weight:200; margin:2rem -0.5rem 1rem -0.5rem; padding-left:0.5rem; padding-right:0.5rem; border-bottom: 3px solid #37474F; text-align: center;}
h2 { font-size:1.75rem; font-weight:200; margin:1.75rem -0.5rem 0.75rem -0.5rem; padding-left:0.5rem; padding-right:0.5rem; border-bottom: 1px solid #37474F; }
h3 { font-size:1.5rem; font-weight:200; margin:1.5rem -0.5rem 0.5rem -0.5rem; padding-left:0.5rem; padding-right:0.5rem; border-bottom: 1px solid #78909C; }
h4 { font-size:1.4rem; font-weight:200; margin:1.4rem 0 0.5rem 0; padding-left:0; padding-right:0;}
h5 { font-size:1.3rem; font-weight:200; margin:1.3rem 0 0.5rem 0; padding-left:0; padding-right:0;}
h6 { font-size:1.2rem; font-weight:200; margin:1.2rem 0 0.5rem 0; padding-left:0; padding-right:0;}
blockquote, p, table, th, td, ul, ol {
    font-family: "Ubuntu"; font-size: 1rem; line-height: 1.3; text-justify:inter-word;
}
em { font-style: italic; }
strong { font-weight:bold; }
blockquote { color:#690c03; margin:1rem 0; padding: 0.2rem 0.5rem; border-left:0.4rem solid #690C03; font-style:italic;}
code, pre { font-family:'Ubuntu Mono'; color:#06065d !important; padding:0 0.2rem; background: white; }
table, th, td { border: 1px solid #044c70; border-collapse: collapse; padding:0.5em; }
p { margin:0.3em 0; }
ul, ol { padding:0 0 0 2rem; margin-top:0.2rem; margin-bottom:0; }
ol ol, ul ol { list-style-type: lower-roman; }
ul ul ol, ul ol ol, ol ul ol, ol ol ol { list-style-type: lower-alpha; }
hr { height:0.2rem; padding:0; margin:1.2rem 0; background-color:#78909C; border: 0 none; }
li>p { margin-top:0.5rem; }
h1,h2,h3,h4,h5,h6 { page-break-after:avoid;page-break-inside:avoid; }
</style></head><body> 
<h1>Bo√Ætes √† secrets - Mod√®le de donn√©es</h1>

<h2>Identification des objets</h2>

<p>Les cl√©s AES et les PBKFD font 32 bytes (44 caract√®res en base64 url).</p>

<p>Le hash des string en <em>integer</em> est un entier sur 53 bits (int√®gre en Javascript):
- 15 chiffres d√©cimaux.
- 9 caract√®res en base64 URL.</p>

<p>Le hash des string en <em>BigInt</em> est un 64 bits (sans signe, toujours positif) :
- 19 chiffres d√©cimaux.
- 12 caract√®res en base64 URL.</p>

<p>Les date-heures sont exprim√©es en micro-secondes depuis le 1/1/1970, soit 52 bits (entier int√®gre en Javascript).</p>

<h3>Compte</h3>

<ul>
<li><code>id</code> : un entier (int√®gre en Javascript) issu de 6 bytes al√©atoires.  </li>
<li><code>cl√© K</code> : 32 bytes al√©atoires.  </li>
<li><code>pcb</code> : PBKFD de la phrase compl√®te (cl√© X) - 32 bytes.  </li>
<li><code>dpbh</code> : hashBin (<em>integer</em>) du PBKFD du d√©but de la phrase secr√®te.</li>
</ul>

<p><strong>La phrase secr√®te d'un compte reste dans le cerveau du titulaire.</strong>
- sa transform√©e par PBKFD d√®s la saisie donne une cl√© AES X qui ne sort jamais de la session cliente et n'est jamais stock√©e de mani√®re permanente.</p>

<p><strong>La cl√© K d'un compte</strong>,
- n'est stock√©e en session comme en serveur que sous forme crypt√©e par X.
- n'est jamais transmise au serveur en clair.
- les donn√©es crypt√©es par K, ne sont lisibles dans le serveur que quand elles ont √©t√© transmises aussi en clair dans une op√©ration. </p>

<h3>Nom complet d'un avatar ou d'un groupe</h3>

<p>Le <strong>nom complet</strong> d'un avatar ou d'un groupe est un string de la forme <code>[nom@rnd]</code>
- <code>nom</code> : nom lisible et signifiant, entre 6 et 20 caract√®res.
- <code>rnd</code> : 32 bytes al√©atoires. Cl√© de cryptage.
- A l'√©cran le nom est affich√© sous la forme <code>nom@abgh</code> ou <code>ab</code> sont les deux premiers caract√®res de l'id en base64 et <code>gh</code> les deux derniers.</p>

<p><strong>Dans les noms,</strong> les caract√®res <code>&lt; &gt; : " / \ | ? *</code> et ceux dont le code est inf√©rieur √† 32 (donc de 0 √† 31) sont interdits afin de permettre d'utiliser le nom complet comme nom de fichier.</p>

<h3>Avatar</h3>

<p>La <strong>cl√© de cryptage</strong> de la carte de visite est <code>rnd</code>.</p>

<p>L'<code>id</code> d'un avatar est le hash (integer) des bytes de <code>rnd</code>, 6 bytes, soit 8 base64.</p>

<h3>Groupe</h3>

<p>La <strong>cl√© de cryptage</strong> du groupe (carte de visite et secrets) est<code>rnd</code>.</p>

<p>L'<code>id</code> d'un groupe est le hash (integer) des bytes de <code>rnd</code>, 6 bytes, soit 8 base64.</p>

<h3>Secret</h3>

<ul>
<li><code>id</code> : du groupe ou de l'avatar propri√©taire</li>
<li><code>ns</code> : num√©ro relatif au groupe / avatar, entier issu de 4 bytes al√©atoires.</li>
</ul>

<h3>Attributs g√©n√©riques</h3>

<ul>
<li><code>v</code> : version, entier.</li>
<li><code>dds</code> : date de derni√®re signature, en nombre de jours depuis le 1/1/2021. Signale que ce jour-l√†, l'avatar, le compte, le groupe √©tait <em>vivant / utile / r√©f√©renc√©</em>. Pour √©viter des rapprochements entre eux, la <em>vraie</em> date de signature peut √™tre entre 0 et 30 jours <em>avant</em>.  </li>
<li><code>ad</code> : pour les avatars seulement, permet de distinguer des seuils d'alerte <code>ad</code> :
<ul><li><em>OK</em> : vivant encore r√©cemment.</li>
<li><em>alerte</em> : des mois sans signe de vie, sera consid√©r√© comme disparu dans les 2 mois qui suivent.</li>
<li><em>disparu</em></li></ul></li>
<li><code>dlv</code> : date limite de validit√©, en nombre de jours depuis le 1/1/2021.</li>
<li><code>st</code> : <code>avatar, contact, invitgr, invitct, parrain, membre, groupe, secret</code> : quand <code>st</code> est n√©gatif c'est le num√©ro de semaine de sa suppression. Les rows ne sont pas supprim√©s physiquement pendant un certain temps afin de permettre aux mises √† jour incr√©mentales des sessions de d√©tecter les suppressions. Une session pour un compte √©tant ouverte au moins tous les 18 mois, les <code>st</code> n√©gatifs de plus de 18 mois peuvent √™tre physiquement supprim√©s.</li>
</ul>

<p>Les comptes sont cens√©s avoir au maximum N semaines entre 2 connexions faute de quoi ils sont consid√©r√©s comme disparus.</p>

<h3>Signatures des comptes, avatars et groupes (<code>dds</code>)</h3>

<p>A chaque connexion d'un compte, le compte signe si la <code>dds</code> actuelle n'est pas <em>r√©cente</em> (sinon les signatures ne sont pas mises √† jour) :
- pour lui-m√™me dans <code>compte</code> : jour de signature tir√© al√©atoirement entre j-28 et j-14.
- pour ses avatars dans <code>avatar</code> : jour de signature tir√© al√©atoirement pour chacun entre j-14 et j.
- pour les groupes auxquels ses avatars sont invit√©s et dont l'acc√®s n'est pas r√©sili√© dans <code>groupe</code> : jour de signature tir√© al√©atoirement pour chacun entre j-14 et j.</p>

<p>Le GC traitement quotidien des <code>dds</code> :
- pour les comptes : purge des rows <code>compte</code> afin de bloquer la connexion.
- pour les groupes : ils n'ont plus d'avatars qui les r√©f√©rencent, purge de leur donn√©es.
- pour les avatars :
  - mise √† jour du statut OK/alerte/disparu.
    - <em>alerte</em> : <em>l'avatar</em> est rest√© plusieurs mois sans connexion.
    - <em>disparu / supprim√©</em> : <em>l'avatar</em> est d√©finitivement disparu.
  - purge / suppression de donn√©es pour les disparus.</p>

<h3>Version des rows</h3>

<p>Les rows des tables devant √™tre pr√©sents sur les clients ont une version, de mani√®re √† pouvoir √™tre charg√©s sur les postes clients de mani√®re incr√©mentale : la version est donc croissante avec le temps et figure dans tous les rows de ces tables. <br>
- utiliser une date-heure pr√©sente l'inconv√©nient de laisser une meta-donn√©e intelligible en base ;
- utiliser un compteur universel a l'inconv√©nient de facilement deviner des liaisons entre objets : par exemple l'invitation √† √©tablir un contact entre A et B n'appara√Æt pas dans les rows eux-m√™mes mais serait lisible si les rows avaient la m√™me version. Crypter l'appartenance d'un avatar √† un groupe alors qu'on peut la lire de facto dans les versions est un probl√®me.
- utiliser un compteur par objet rend complexe la g√©n√©ration de SQL avec des filtres qui associent chaque objet √† sa derni√®re version connue.</p>

<p>Tous les objets synchronisables (sauf les comptes) sont identifi√©s, au moins en majeur, par une id d'avatar ou de groupe. Par exemple l'obtention des contacts d'un avatar se fait par une s√©lection d'abord sur l'id de l'avatar, puis sur sa version pour ne r√©cup√©rer incr√©mentalement que ceux chang√©s / cr√©√©s. D'o√π l'option de g√©rer <strong>une s√©quence de versions</strong>, pas par id d'avatar, mais par hash de cet id.</p>

<h4><code>vcv</code> : version de la carte de visite d'un avatar</h4>

<p>Afin de pouvoir rafra√Æchir uniquement les cartes de visites des avatars, la propri√©t√© vcv de avatar donne la version dans la s√©quence universelle</p>

<h2>Tables</h2>

<ul>
<li><code>versions</code> (id) : table des prochains num√©ros de versions (actuel et derni√®re sauvegarde) et autres singletons (id value)</li>
<li><code>avgrvq</code> (id) : volumes et quotas d'un avatar ou groupe  </li>
<li><code>avrsa</code> (id) : cl√© publique d'un avatar</li>
</ul>

<p><em><strong>Tables aussi persistantes sur le client (IDB)</strong></em></p>

<ul>
<li><code>compte</code> (id) : authentification et liste des avatars d'un compte </li>
<li><code>prefs</code> (id) : donn√©es et pr√©f√©rences d'un compte </li>
<li><code>avatar</code> (id) : donn√©es d'un avatar et liste de ses contacts</li>
<li><code>invitgr</code> (id, ni) : invitation re√ßue par un avatar √† devenir membre d'un groupe</li>
<li><code>contact</code> (id, ic) : donn√©es d'un contact d'un avatar    </li>
<li><code>rencontre</code> (prh) id : communication par A de son nom complet √† un avatar B non connu de A dans l'application</li>
<li><code>parrain</code> (pph) id : parrainage par un avatar A de la cr√©ation d'un nouveau compte</li>
<li><code>groupe</code> (id) : donn√©es du groupe et liste de ses avatars, invit√©s ou ayant √©t√© pressentis, un jour √† √™tre membre.</li>
<li><code>membre</code> (id, im) : donn√©es d'un membre du groupe</li>
<li><code>secret</code> (id, ns) : donn√©es d'un secret d'un avatar ou groupe</li>
</ul>

<h2>Singletons id / valeur</h2>

<p>Ils sont identifi√©s par un num√©ro de singleton. <br>
- Leur valeur est un BLOB, qui peut √™tre un JSON en UTF8. <br>
- Le singleton 0 est un JSON libre utilis√© pour stocker l'√©tat du serveur (derni√®re sauvegarde, etc.). <br>
- C'est la table <code>versions</code> qui les stocke.</p>

<h2>Table <code>versions</code> - CP : <code>id</code></h2>

<p>Au lieu d'un compteur par avatar / groupe / compte on a 100 compteurs, un compteur pour plusieurs avatars / groupe (le reste de la division de l'id par 99 + 1). Le compteur 0 est celui de la s√©quence universelle.</p>

<p>La colonne <code>v</code> est un array d'entiers.</p>

<blockquote>
  <p>Le nombre de collisions n'est pas vraiment un probl√®me : d√©tecter des proximit√©s entre avatars / groupes dans ce cas devient un exercice tr√®s incertain (fiabilit√© de 1 sur 99).</p>
</blockquote>

<p>L'id 0 correspondant √† l'√©tat courant et l'id 1 √† la derni√®re sauvegarde.</p>

<pre><code>CREATE TABLE "versions" (
"id"  INTEGER,
"v"  BLOB,
PRIMARY KEY("id")
) WITHOUT ROWID;
</code></pre>

<h2>Table <code>avgrvq</code> - CP <code>id</code>. Volumes et quotas des avatars et groupes</h2>

<p>Pour chaque avatar et groupe, par convention la <em>banque centrale</em> est l'avatar d'id 1, 
- <code>v1 v2</code> : les volumes utilis√©s augmentent quand des secrets sont rendus persistants ou mis √† jour en augmentation et diminuent quand ils sont supprim√©s ou mis √† jour en r√©duction : ce sont des actions qui peuvent √™tre d√©clench√©es par d'autres comptes (maj d'un secret d√©j√† persistant).
- <code>vm1 vm2</code> : volumes consomm√©s dans le mois. Le changement de mois remet √† 0 <code>vm1</code> et <code>vm2</code>.
- <code>q1 q2 qm1 qm2</code> : quotas donn√©s √† un groupe / avatar par une groupe / avatar / banque. En cas de GC d'un avatar / groupe, ils sont retourn√©s √† la banque. </p>

<p>Pour un groupe il n'y a pas de <code>vm1 vm2 qm1 qm2</code>.</p>

<p>Les transferts de quotas entre avatars / groupes / banque centrale se font sous la forme d'un d√©bit / cr√©dit.
- <em>Normalement</em> les sommes des quotas doivent √™tre nulles.
- <em>Normalement</em> les volumes doivent √™tre inf√©rieurs √† leur quotas.</p>

<p>Table :</p>

<pre><code>CREATE TABLE "avgrvq" (
"id"    INTEGER,
"q1"    INTEGER,
"q2"    INTEGER,
"qm1"   INTEGER,
"qm2"   INTEGER,
"v1"    INTEGER,
"v2"    INTEGER,
"vm1"   INTEGER,
"vm2"   INTEGER,
"vsh"   INTEGER,
PRIMARY KEY("id")
) WITHOUT ROWID;
</code></pre>

<p><strong>Op√©ration mensuelle</strong> <br>
Les volumes mensuels sont mis √† 0 le premier de chaque mois √† minuit. Le cas √©ch√©ant l'occasion de sortir des statistiques sur un fichier <code>xls</code>. </p>

<h2>Table : <code>compte</code> CP <code>id</code>. Authentification d'un compte</h2>

<p><em>Phrase secr√®te</em> : une ligne 1 de 16 caract√®res au moins et une ligne 2 de 16 caract√®res au moins. <br>
<code>pcb</code> : PBKFD de la phrase compl√®te (cl√© X) - 32 bytes. <br>
<code>dpbh</code> : hashBin (53 bits) du PBKFD du d√©but de la phrase secr√®te (32 bytes).</p>

<p>Table :</p>

<pre><code>CREATE TABLE "compte" (
"id"    INTEGER,
"v"     INTEGER,
"dpbh"  INTEGER,
"pcbh"  INTEGER,
"kx"   BLOB,
"cpriv" BLOB,
"mack"  BLOB,
"vsh"   INTEGER,
PRIMARY KEY("id")
) WITHOUT ROWID;
CREATE UNIQUE INDEX "dpbh_compte" ON "compte" ( "dpbh" );
</code></pre>

<ul>
<li><code>id</code> : id du compte.</li>
<li><code>v</code> :</li>
<li><code>dpbh</code> : hashBin (53 bits) du PBKFD du d√©but de la phrase secr√®te (32 bytes). Pour la connexion, l'id du compte n'√©tant pas connu de l'utilisateur.</li>
<li><code>pcbh</code> : hashBin (53 bits) du PBKFD de la phrase compl√®te pour quasi-authentifier une connexion avant un √©ventuel √©chec de d√©cryptage de <code>kx</code>.</li>
<li><code>cpriv</code> : cl√© asym√©trique priv√©e du compte (pour g√©rer les rencontres entre comptes). La cl√© publique est dans la table <code>avrsa</code>.</li>
<li><code>kx</code> : cl√© K du compte, crypt√© par la X (phrase secr√®te courante).</li>
<li><code>mack</code> {} : map des avatars du compte crypt√©e par la cl√© K. Cl√©: id, valeur: <code>[nom, rnd, cpriv]</code>
<ul><li><code>nom rnd</code> : nom complet.</li>
<li><code>cpriv</code> : cl√© priv√©e asym√©trique.
premi√®re ligne s'affiche en haut de l'√©cran.</li></ul></li>
<li><code>vsh</code></li>
</ul>

<p><strong>Remarques :</strong> 
- un row <code>compte</code> ne peut √™tre modifi√© que par une transaction du compte (mais peut √™tre purg√© par le traitement journalier de d√©tection des disparus).
- il est synchronis√© lorsqu'il y a plusieurs sessions ouvertes en parall√®le sur le m√™me compte depuis plusieurs sessions de browsers.
- chaque mise √† jour v√©rifie que <code>v</code> actuellement en base est bien celle √† partir de laquelle l'√©dition a √©t√© faite pour √©viter les mises √† jour parall√®les intempestives.
- le row <code>compte</code> change tr√®s rarement : √† l'occasion de l'ajout / suppression d'un avatar et d'un changement de phrase secr√®te.</p>

<h2>Table : <code>prefs</code> CP <code>id</code>. Pr√©f√©rences et donn√©es d'un compte</h2>

<p>Afin que le row compte qui donne la liste des avatars ne soit mis √† jour que rarement, les donn√©es et pr√©f√©rences associ√©es au compte sont m√©moris√©es dans une autre table :
- chaque type de donn√©es porte un code court :
  - <code>mp</code> : m√©mo personnel du titulaire du compte.
  - <code>mc</code> : mots cl√©s du compte.
  - <code>fs</code> : filtres des secrets.
- le row est juste un couple <code>[id, map]</code> o√π map est la s√©rialisation d'une map ayant :
  - une entr√©e pour chacun des codes courts ci-dessus : la map est donc extensible sans modification du serveur.
  - pour valeur la s√©rialisation crypt√©e par la cl√© K du compte de l'objet Javascript en donnant le contenu.
- le row est charg√© lors de l'identification du compte, conjointement avec le row compte.
- une mise √† jour ne correspond qu'√† un seul code court afin de r√©duire le risque d'√©crasements entre sessions parall√®les/</p>

<p>Table :</p>

<pre><code>CREATE TABLE "prefs" (
"id"    INTEGER,
"v"     INTEGER,
"mapk" BLOB,
"vsh"   INTEGER,
PRIMARY KEY("id")
) WITHOUT ROWID;
</code></pre>

<ul>
<li><code>id</code> : id du compte.</li>
<li><code>v</code> :</li>
<li><code>mapk</code> {} : map des pr√©f√©rences.</li>
<li><code>vsh</code></li>
</ul>

<h2>Table <code>compta</code> : CP <code>id</code>. Ligne comptable d'un compte</h2>

<p>Il y a une ligne par compte, l'id √©tant l'id du compte. idp est l'id du parrain pour un filleul : un parrain a donc null dans cette colonnes.</p>

<p>Table :</p>

<pre><code>CREATE TABLE "compta" (
"id"    INTEGER,
"idp"   INTEGER,
"v" INTEGER,
"dds"   INTEGER,
"st"    INTEGER,
"data"  BLOB,
"vsh"   INTEGER,
PRIMARY KEY("id")
) WITHOUT ROWID;
CREATE INDEX "idp_compta" ON "compta" ( "idp" );
CREATE INDEX "dds_compta" ON "compta" ( "dds" );
CREATE INDEX "st_compta" ON "compta" ( "st" ) WHERE "st" &gt; 0;
</code></pre>

<ul>
<li><code>id</code> : du compte.</li>
<li><code>idp</code> : pour un filleul, id du parrain (null pour un parrain).</li>
<li><code>v</code> :</li>
<li><code>dds</code> : date de derni√®re signature du compte (derni√®re connexion). Un compte en sursis ou bloqu√© ne signe plus, sa disparition physique est d√©j√† programm√©e.</li>
<li><code>st</code> :
<ul><li>0 : normal.</li>
<li>1 : en sursis 1.</li>
<li>2 : en sursis 2.</li>
<li>3 : bloqu√©.</li></ul></li>
<li><code>dst</code> : date du dernier changement de st.</li>
<li><code>data</code>: compteurs s√©rialis√©s (non crypt√©s)</li>
<li><code>vsh</code> :</li>
</ul>

<p><strong>data</strong>
- <code>j</code> : jour de calcul
- <code>v1 v1m</code> : volume v1 actuel et total du mois
- <code>v2 v2m</code> : volume v2 actuel et total du mois
- <code>f1 f2</code> : forfait de v1 et v2
- <code>tr</code> : array de 31 compteurs (les 31 derniers jours) : cumul journalier du volume de transfert de pi√®ces jointes.
- <code>hist</code> : array de 12 √©l√©ments, un par mois. 4 bytes par √©l√©ments.
  - <code>f1 f2</code> : forfaits du mois
  - <code>r1</code> : ratio du v1 du mois par rapport √† son forfait.
  - <code>r2</code> : ratio du v2 du mois par rapport √† son forfait.
- <code>res1 res2</code> : pour un parrain, r√©serve de forfaits v1 et v2.
- <code>t1 t2</code> : pour un parrain, total des forfaits 1 et 2 attribu√©s aux filleuls.</p>

<h4>Unit√©s de volume</h4>

<ul>
<li>pour v1 : 1 MB</li>
<li>pour v2 : 100 MB</li>
</ul>

<p>Les forfaits, pour les comptes, pour les groupes, pour la r√©serve, peuvent √™tre donn√©s en nombre d'unit√©s ci-dessus.</p>

<p>Les forfaits typiques s'√©tagent de 1 √† 64 : (co√ªt mensuel)
- (1) - XXS - 1 MB / 100 MB - 0,35c
- (2) - XS - 2 MB / 200 MB - 0,70c
- (4) - SM - 4 MB / 400 MB - 1,40c
- (8) - MD - 8 MB / 800 MB - 2,80c
- (16) - LG - 16 MB / 1,6GB - 5,60c
- (32) - XL - 32 MB / 3,2GB - 1,12‚Ç¨
- (64) - XXL - 64 MB / 6,4GB - 2,24‚Ç¨</p>

<p>Les codes <em>num√©riques</em> des forfaits tiennent sur 1 octet : c'est le facteur multiplicateur du forfait le plus petit (1MB / 100MB). Des codes symboliques peuvent √™tre ajout√©s, voire modifi√©s, sans affecter les donn√©es.</p>

<p>Les <em>ratios</em> sont exprim√©s en pourcentage de 1 √† 255% : mais 1 est le minimum (&lt; 1 fait 1) et 255 le maximum.</p>

<h2>Table <code>ardoise</code> : CP <code>id</code>. Ardoise supportant les √©changes d'administration d'un compte</h2>

<p>Il y a une ardoise par compte, l'id √©tant l'id du compte.</p>

<p>Table :</p>

<pre><code>CREATE TABLE "ardoise" (
"id"    INTEGER,
"dh"  INTEGER,
"data"  BLOB,
"vsh"   INTEGER,
PRIMARY KEY("id")
) WITHOUT ROWID;
</code></pre>

<ul>
<li><code>id</code> : du compte.</li>
<li><code>dh</code> : date-heure de derni√®re mise √† jour.</li>
<li><code>data</code>: contenu s√©rialis√© <em>crypt√© soft</em> de l'ardoise.</li>
<li><code>vsh</code>:</li>
</ul>

<p>L'ardoise est une s√©quence chronologique d'√©changes. Chacun concerne,
- un compte,
- son compte parrain √©ventuel,
- les comptables : toujours concern√©s, ils lisent les ardoises en fonction de la date-heure de derni√®re modification.</p>

<p>Quand un compte a un parrain, l'√©change est <strong>d√©doubl√©</strong> sur les deux ardoises du filleul et du parrain.
- <code>dh</code> : date-heure de l'√©change
- <code>idp</code> : id du parrain
- <code>idf</code> : id du filleul
- <code>em</code> : √©mis par, 0 - le compte, 1 - son parrain, 2 - le comptable
- <code>texte</code> : court.</p>

<p>Une ardoise conserve,
- tous les √©changes de moins de 6 semaines,
- au moins les 10 derniers quels qu'en soit la date.</p>

<h2>Table <code>avrsa</code> : CP <code>id</code>. Cl√© publique RSA des avatars</h2>

<p>Cette table donne la cl√© RSA (publique) obtenue √† la cr√©ation de l'avatar : elle permet d'inviter un avatar √† √™tre contact fort ou √† devenir membre d'un groupe.</p>

<p>Table :</p>

<pre><code>CREATE TABLE "avrsa" (
"id"    INTEGER,
"clepub"    BLOB,
"vsh"   INTEGER,
PRIMARY KEY("id")
) WITHOUT ROWID;
</code></pre>

<ul>
<li><code>id</code> : id de l'avatar.</li>
<li><code>clepub</code> : cl√© publique.</li>
<li><code>vsh</code></li>
</ul>

<h3>Table <code>avatar</code> : CP <code>id</code>. Donn√©es d'un avatar</h3>

<p>Chaque avatar a un row dans cette table :
- donne son statut de disparition <em>OK alerte disparu</em> en h√©bergeant sa derni√®re signature de connexion,
- sa carte de visite,
- la liste de ses avatars en contact afin de garantir l'absence de doublons.</p>

<p>Table :</p>

<pre><code>CREATE TABLE "avatar" (
"id"   INTEGER,
"v"     INTEGER,
"st"  INTEGER,
"vcv" INTEGER,
"dds" INTEGER,
"cva"   BLOB,
"lgrk" BLOB,
"vsh"   INTEGER,
PRIMARY KEY("id")
) WITHOUT ROWID;
CREATE INDEX "id_v_avatar" ON "avatar" ( "id", "v" );
CREATE INDEX "dds_avatar" ON "avatar" ( "dds" );
CREATE INDEX "id_vcv_avatar" ON "avatar" ( "id", "vcv");
CREATE INDEX "st_avatar" ON "avatar" ( "st" ) WHERE "st" &lt; 0;
</code></pre>

<ul>
<li><code>id</code> : id de l'avatar</li>
<li><code>v</code> :</li>
<li><code>st</code> : 
<ul><li>n√©gatif : l'avatar est supprim√© / disparu (les autres colonnes sont √† null). </li>
<li>0 : OK</li>
<li>N : alerte.</li>
<li>1 : d√©tect√© par le GC, <em>l'avatar</em> est rest√© plusieurs mois sans connexion.</li>
<li>J : auto-d√©truit le jour J: c'est un d√©lai de remord. Quand un compte d√©truit un de ses avatars, il a N jours depuis la date courante pour se r√©tracter et le r√©activer.</li></ul></li>
<li><code>vcv</code> : version de la carte de visite (s√©quence 0).</li>
<li><code>dds</code> :</li>
<li><code>cva</code> : carte de visite de l'avatar crypt√©e par la cl√© de l'avatar <code>[photo, info]</code>.</li>
<li><code>lgrk</code> : map :
<ul><li><em>cl√©</em> : <code>ni</code>, num√©ro d'invitation (al√©atoire 4 bytes) obtenue sur <code>invitgr</code>.</li>
<li><em>valeur</em> : crypt√©e par la cl√© K du compte de <code>[nom, rnd, im]</code> re√ßu sur <code>invitgr</code> et inscrit √† l'acceptation de l'invitation.</li>
<li>une entr√©e est effac√©e par la r√©siliation du membre au groupe ou sur refus de l'invitation (ce qui lui emp√™che de continuer √† utiliser la cl√© du groupe).</li></ul></li>
<li><code>vsh</code></li>
</ul>

<p>La lecture de <code>avatar</code> permet d'obtenir la liste des groupes dont il est membre.</p>

<p>Sur GC quotidien sur <code>dds</code> : 
- mise √† jour du statut <code>st</code> OK/alerte/disparu.
  - <em>alerte</em> (1): <em>l'avatar</em> est rest√© plusieurs mois sans connexion.
  - <em>disparu / supprim√©</em> (&lt;0): <em>l'avatar</em> est d√©finitivement disparu.
- purge / suppression des donn√©es pour les disparus.</p>

<p><strong>Remarques</strong>
- √† la signature d'un avatar, quand <code>dds</code> doit √™tre mise √† jour :
  - si le statut √©tait <em>OK</em>, <code>v</code> n'est <strong>pas</strong> chang√©,
  - si le statut √©tait <em>alerte</em> (et va donc repasser √† <em>OK</em>), <code>v</code> est chang√©e afin que la mise √† jour soit propag√©e dans les stockage off line.
- l'√©tat disparu est immuable, un avatar ne <em>rena√Æt</em> jamais, le row <code>avatar</code> est marqu√© <em>supprim√©</em>, les autres propri√©t√©s sont mise √† null et le row sera physiquement d√©truit 14 mois apr√®s sa suppression logique. Tous les comptes concern√©s se seront connect√©s et auront pris en compte la suppression logique.</p>

<h3>Table <code>contact</code> : CP <code>id ic</code>. Contact d'un avatar A</h3>

<p>Un contact entre A et B est cr√©√© par exemple √† l'initiative de A et a deux exemplaires : l'un dont l'id est celle de A, l'autre dont l'id est celle de B :
- <code>ic</code> de <code>C[a]</code>, l'indice du contact B chez A, est tir√© au hasard.
- <code>ic</code> de <code>C[b]</code>, l'indice du contact de A chez B est le <em>hash sur un entier de l'encryption</em> par <code>K</code> de l'id de B.</p>

<p>L'op√©ration de cr√©ation v√©rifie que le contact C[b] n'existe pas afin de se pr√©munir contre une cr√©ation parall√®le de deux sessions du compte A. Le fait que son ic ne soit pas al√©atoire est une garantie.
- la cl√© <code>cc</code> du couple est tir√©e au hasard.
- deux contacts <code>C[a]</code> et <code>C[b]</code> sont cr√©√©s :
  - dans <code>C[b]</code> <code>data</code> contient :
    - le <code>nom rnd</code> de A,
    - la cl√© <code>cc</code>,
    - l'indice <code>ic</code> du contact chez A qui permet donc √† B d'acc√©der au contact <code>C[a]</code>
    - <code>data</code> est crypt√© par la <strong>cl√© publique de B</strong>.
    - <code>mc</code> contient une seule valeur 200 qui signifie <em>nouveau</em>.
  - dans <code>C[a]</code> <code>data</code> contient :]
    - le <code>nom rnd</code> de B,
    - la cl√© <code>cc</code>,
    - l'indice ic du contact chez B qui permet √† A d'acc√©der au contact <code>C[b]</code>
    - <code>data</code> est crypt√© par la <strong>cl√© K du compte de A</strong>.</p>

<p>Juste avant d'√©mettre une op√©ration de cr√©ation, la session du compte de A v√©rifie qu'il n'existe aucun contact C dont le <code>data.nom rnd</code> correspond √† l'id de B : en effet B <em>pourrait</em> avoir devanc√© de peu A et cr√©√© le contact qui est parvenu par synchronisation √† A pendant le processus de cr√©ation.</p>

<p>Quand une session de B obtient par chargement initial ou synchronisation le <em>nouveau</em> contact <code>C[b]</code> elle poste imm√©diatement une op√©ration de <code>regularisationCT</code> qui remplace le <code>datap</code> par le m√™me contenu crypt√© par sa cl√© K <code>datak</code>, <code>datap</code> passant √† null.
- <code>datap / datak</code> sont immuables apr√®s cr√©ation, de m√™me que l'identifiant <code>id ic</code>.
- en session et en base locale, <code>datap</code> n'existe jamais et <code>datak</code> est d√©crypt√©e en <code>data</code>.</p>

<p>L'op√©ration de cr√©ation v√©rifie √©galement qu'il n'existe aucun contact non r√©gularis√© (ayant un <code>datap</code> non null) pour le cr√©ateur.</p>

<p><strong>Statuts r√©ciproques x/y</strong>
- le statut xy de C[a] est √®gal au statut yx de C[b]
- x prend 3 valeurs (par exemple pour C[a]):
  0: A n'accepte pas le partage de secrets avec B.
  1: A accepte le partage de secrets avec B.
  2: A a disparu. Ce statut ne peut appara√Ætre qu'en position y (l'avatar disparu n'ayant plus de contacts).</p>

<p>Tant que A et B n'ont pas disparu, un contact reste √©ternel, mais A par exemple :
- peut arr√™ter d'accepter de partager des secrets (voir n'avoir jamais accept√©),
- peut ne pas lire l'ardoise commune,
- peut mettre sur le contact un mot cl√© <em>liste noire</em> qui fait que le contact avec B n'appara√Ætra plus dans ses listes √† l'√©cran (jusqu'√† lev√©e √©ventuelle de ce mot cl√©). </p>

<blockquote>
  <p>La cl√© cc relative √† un couple A/B ne doit jamais dispara√Ætre avant que A et B n'aient disparu : elle crypte leurs secrets partag√©s.</p>
</blockquote>

<p>Un contact permet de partager par <strong>l'ardoise</strong> un court texte entre A et B pour justifier d'un changement de statut ou n'importe quoi d'autre : en particulier quand A n'accepte pas / plus le partage de secrets avec B par exemple, c'est le seul moyen pour passer une courte information mutuelle qui n'encombre pas leurs volumes respectifs.</p>

<p>Table :</p>

<pre><code>CREATE TABLE "contact" (
"id"   INTEGER,
"ic"    INTEGER,
"v"     INTEGER,
"st" INTEGER,
"ardc"  BLOB,
"datap"  BLOB
"datak" BLOB,
"mc"  BLOB,
"infok" BLOB,
"vsh"   INTEGER,
PRIMARY KEY("id", "ic"));
CREATE INDEX "id_v_contact" ON "contact" ( "id", "v" );
CREATE INDEX "st_contact" ON "contact" ( "st" ) WHERE "st" &lt; 0;
</code></pre>

<ul>
<li><code>id</code> : id de l'avatar A</li>
<li><code>ic</code> : indice de contact de B pour A.</li>
<li><code>v</code> :</li>
<li><code>st</code> : statut entier de 2 chiffres, <code>x y</code> : <strong>les valeurs &lt; 0 indiquent un row supprim√© (les champs apr√®s sont null)</strong>. <code>xy</code> dans le contact de A est <code>yx</code> dans le contact de B.
<ul><li><code>x</code> :</li>
<li>0 : n'accepte pas le partage de secrets.</li>
<li>1 : accepte le partage de secrets.</li>
<li>2 : pr√©sum√© disparu</li></ul></li>
<li><code>ardc</code> : <strong>ardoise</strong> partag√©e entre A et B crypt√©e par la cl√© <code>cc</code> associ√©e au contact <em>fort</em> avec un avatar B. Couple <code>[dh, texte]</code>.</li>
<li><code>datak</code> : information crypt√©e par la cl√© K de A.
<ul><li><code>nom rnd ic</code> : nom complet du contact (B) et son indice chez lui.</li>
<li><code>cc</code> : 32 bytes al√©atoires donnant la cl√© <code>cc</code> d'un contact avec B (en attente ou accept√©).</li></ul></li>
<li><code>datap</code> : m√™mes donn√©es que <code>datak</code> mais crypt√©es par la cl√© publique de A.</li>
<li><code>mc</code> : mots cl√©s √† propos du contact.</li>
<li><code>infok</code> : commentaire √† propos du contact crypt√© par la cl√© K du membre.</li>
<li><code>vsh</code></li>
</ul>

<p>Un contact est <strong>supprim√©</strong> (<code>st</code> &lt; 0) quand les A et B ont disparu: les colonnes <code>ardc dataP/datak mc infok</code> sont null.</p>

<h3>Table <code>parrain</code> : CP <code>pph</code>. Parrainage par P de la cr√©ation d'un compte F</h3>

<p>F est un <em>inconnu</em> n'ayant pas encore de compte.</p>

<p>Comme il va y avoir un don de quotas du <em>parrain</em> vers son <em>filleul</em>, ces deux-l√† vont avoir un contact <em>fort</em> (si F accepte). Toutefois,
- P peut indiquer que son contact est sans partage de secrets.
- F pourra indiquer que son contact est sans partage de secrets.</p>

<p>Le parrain fixe l'avatar filleul (donc son nom). Le filleul √©tablira le contact lors de son acceptation du parrainage.</p>

<p>Un parrainage est identifi√© par le hash du PBKFD de la phrase de parrainage pour √™tre retrouv√©e par le filleul.</p>

<pre><code>CREATE TABLE "parrain" (
"pph"  INTEGER,
"id" INTEGER,
"v"   INTEGER,
"dlv"  INTEGER,
"st"  INTEGER,
"f1" INTEGER,
"f2" INTEGER,
"datak"  BLOB,
"datax"  BLOB,
"ardc"  BLOB,
"vsh"   INTEGER,
PRIMARY KEY("pph")
) WITHOUT ROWID;
CREATE INDEX "dlv_parrain" ON "parrain" ( "dlv" );
CREATE INDEX "id_parrain" ON "parrain" ( "id" );
</code></pre>

<ul>
<li><code>pph</code> : hash du PBKFD de la phrase de parrainage.</li>
<li><code>id</code> : id du parrain.</li>
<li><code>v</code></li>
<li><code>dlv</code> : la date limite de validit√© permettant de purger les parrainages (quels qu'en soient les statuts).</li>
<li><code>st</code> : &lt; 0: supprim√©,
<ul><li>0: en attente de d√©cision de F</li>
<li>1 : accept√©</li>
<li>2 : refus√©</li></ul></li>
<li><code>f1 f2</code> : forfaits attribu√©s par P √† F.</li>
<li><code>datak</code> : crypt√©e par la cl√© K du parrain, <strong>phrase de parrainage et cl√© X</strong> (PBKFD de la phrase). La cl√© X figure afin de ne pas avoir √† recalculer un PBKFD en session du parrain pour qu'il puisse afficher <code>datax</code>.</li>
<li><code>datax</code> : donn√©es de l'invitation crypt√©es par le PBKFD de la phrase de parrainage.
<ul><li><code>nomp, rndp, icp</code> : nom complet et indice de l'avatar P.</li>
<li><code>nomf, rndf, icf</code> : nom complet et indice du filleul F (donn√© par P).</li>
<li><code>cc</code> : cl√© <code>cc</code> g√©n√©r√©e par P pour le couple P / F.</li>
<li><code>aps</code> : <code>true</code> si le parrain accepte le partage de secrets.</li></ul></li>
<li><code>datak2</code> : c'est le <code>datak</code> du futur contact cr√©√© en cas d'acceptation.
<ul><li><code>nom rnd</code> : nom complet du contact (B).</li>
<li><code>cc</code> : 32 bytes al√©atoires donnant la cl√© <code>cc</code> d'un contact avec B (en attente ou accept√©).</li>
<li><code>icb</code> : indice de A dans les contacts de B</li></ul></li>
<li><code>ardc</code> : ardoise (couple <code>[dh, texte]</code> crypt√©e par la cl√© <code>cc</code>).
<ul><li>du parrain, mot de bienvenue √©crit par le parrain (crypt√©e par la cl√© <code>cc</code>).</li>
<li>du filleul, explication du refus par le filleul (crypt√©e par la cl√© <code>cc</code>) quand il d√©cline l'offre. Quand il accepte, ceci est inscrit sur l'ardoise de leur contact afin de ne pas dispara√Ætre.</li></ul></li>
<li><code>vsh</code></li>
</ul>

<p>Apr√®s cr√©ation les seuls champs pouvant changer, avant acceptation ou refus explicite, sont  :
- <code>f1 f2</code> : que le parrain peut ajuster.
- <code>ardc</code> : permettant un dialogue simplifi√© entre parrain et filleul.</p>

<p><strong>Les forfaits sur la r√©serve du parrain lors de l'acceptation.</strong> </p>

<p><strong>Si le filleul ne fait rien √† temps : (<code>st</code> toujours √† 0)</strong> 
- Lors du GC sur la <code>dlv</code>, le row <code>parrain</code> sera supprim√© par GC de la <code>dlv</code>. </p>

<p><strong>Si le filleul refuse le parrainage :</strong> 
- L'ardoise contient une justification / remerciement du refus.
- Le row <code>parrain</code> sera supprim√© √† l'expiration de la <code>dlv</code>. </p>

<p><strong>Le parrain peut annuler son row avant acceptation / refus :</strong> 
- son <code>st</code> passe √† &lt; 0.</p>

<p><strong>Si le filleul accepte le parrainage :</strong> 
- Le filleul cr√©e son compte et son premier avatar (dont il a re√ßu <code>nom rnd</code>).
- sa ligne <code>compta</code> est cr√©√©e et cr√©dit√©s des forfaits attribu√©s par le parrain.
- la ligne <code>compta</code> du parrain est mise √† jour (total des forfaits et r√©serve).
- il cr√©√© un double contact C[p] et C[f] avec P.
  - dans <code>C[p]</code> le <code>datak</code> est le <code>datak2</code> transmis dans le row <code>parrain</code> : ce contact est d√©j√† r√©gularis√© d√®s sa cr√©ation.
  - dans <code>C[f]</code> le <code>datak</code> est cr√©√© √† partir des donn√©es contenues dans le <code>datax</code> du row <code>parrain</code>.
- l'ardoise des <code>contact</code> de P et de F contient l'ardoise de l'acceptation (<code>ardc</code>).
- Le row <code>parrain</code> a son <code>st</code> √† 1 et sera supprim√© √† l'expiration de la <code>dlv</code>. </p>

<p>Dans tous les cas le GC sur <code>dlv</code> supprime le row <code>parrain</code>. Les quotas ne sont restitu√©s au parrain que si le statut est rest√© 0 (en attente).</p>

<h2>Table <code>rencontre</code> : CP <code>prh</code>. Rencontre entre les avatars A et B</h2>

<p>A et B se sont rencontr√©s dans la <em>vraie</em> vie mais ni l'un ni l'autre n'a les coordonn√©es de l'autre pour,
- soit s'inviter √† cr√©er un contact,
- soit pour B inviter A √† participer √† un groupe.</p>

<p>Une rencontre est juste un row qui va permettre √† A de transmettre √† B son <code>nom rnd</code> en utilisant une phrase de rencontre convenue entre eux. <br>
En acc√©dant √† cette rencontre B pourra inscrire A comme contact ou l'inviter √† un groupe.</p>

<p>Une rencontre est identifi√©e par <code>prh</code> le hash de la <strong>cl√© X (PBKFD de la phrase de rencontre)</strong>.</p>

<pre><code>CREATE TABLE "rencontre" (
"prh" INTEGER,
"id" INTEGER,
"v"   INTEGER,
"dlv" INTEGER,
"st"  INTEGER,
"datak" BLOB,
"nomax" BLOB,
"nombx" BLOB,
"ardx"  BLOB,
"vsh"   INTEGER,
PRIMARY KEY("prh")
) WITHOUT ROWID;
CREATE INDEX "dlv_rencontre" ON "rencontre" ( "dlv" );
CREATE INDEX "id_v_rencontre" ON "rencontre" ( "id", "v" );
</code></pre>

<ul>
<li><code>prh</code> : hash du PBKFD de la phrase de rencontre.</li>
<li><code>id</code> : id de l'avatar A ayant initi√© la rencontre.</li>
<li><code>v</code> :</li>
<li><code>dlv</code> : date limite de validit√© permettant de purger les rencontres.</li>
<li><code>st</code> : &lt; 0:annul√©e, 0:en attente</li>
<li><code>datak</code> : <strong>phrase de rencontre et son PBKFD</strong> (cl√© X) crypt√©e par la cl√© K du compte A pour que A puisse retrouver les rencontres qu'il a initi√©es avec leur phrase.</li>
<li><code>nomax</code> : nom complet <code>[nom, rnd]</code> de A crypt√© par la cl√© X.</li>
<li><code>nombx</code> : nom complet de B nom rnd quand B a lu la rencontre.</li>
<li><code>ardx</code> : ardoise de A (mot de bienvenue). Couple <code>[dh, texte]</code> crypt√© par la cl√© X.</li>
<li><code>vsh</code></li>
</ul>

<p>Quand B <em>ouvre</em> la rencontre, il laisse son <code>nom rnd</code> dans cette rencontre : A comme B peuvent d√©cider ensuite de cr√©er un contact et/ou s'inviter √† des groupes.</p>

<p>Le GC sur <code>dlv</code> d√©truit le row <code>rencontre</code> (<code>st</code> &lt; 0, <code>nombx / nomax / ardx</code> sont mis √† null).</p>

<p>A peut annuler la rencontre (remord), <code>st</code> passe √† &lt; 0.</p>

<h2>Table <code>groupe</code> : CP: <code>id</code>. Ent√™te et √©tat d'un groupe</h2>

<p>Un groupe est caract√©ris√© par :
- ses quotas et volumes : un row de <code>avgrvq</code>,
- son ent√™te : un row de <code>groupe</code>.
- la liste de ses membres : des rows de <code>membre</code>.
- la liste de ses secrets : des rows de <code>secret</code>.</p>

<p>Table :</p>

<pre><code>CREATE TABLE "groupe" (
"id"  INTEGER,
"v"   INTEGER,
"dds" INTEGER,
"st"  INTEGER,
"stxy"  INTEGER,
"cvg"  BLOB,
"idhg"  BLOB,
"v1"  INTEGER,
"v2"  INTEGER,
"f1"  INTEGER,
"f2"  INTEGER,
"mcg"   BLOB,
"vsh"   INTEGER,
PRIMARY KEY("id")
) WITHOUT ROWID;
CREATE INDEX "id_v_groupe" ON "groupe" ( "id", "v" );
CREATE INDEX "st_groupe" ON "groupe" ( "st" ) WHERE "st" &lt; 0;
</code></pre>

<ul>
<li><code>id</code> : id du groupe.</li>
<li><code>v</code> :</li>
<li><code>dds</code> :</li>
<li><code>st</code> : statut
<ul><li>n√©gatif : l'avatar est supprim√© / disparu (les autres colonnes sont √† null).</li>
<li>0 : OK</li>
<li>N : alerte.</li>
<li>1 : d√©tect√© par le GC, <em>le groupe</em> est rest√© plusieurs mois sans connexion.</li>
<li>J : auto-d√©truit le jour J: c'est un d√©lai de remord. Quand un compte d√©truit un groupe, il a N jours depuis la date courante pour se r√©tracter et le r√©activer.</li></ul></li>
<li><code>stxy</code> : Deux chiffres <code>x y</code>
<ul><li><code>x</code> : 1-ouvert, 2-ferm√©, 3-r√©-ouverture en vote</li>
<li><code>y</code> : 0-en √©criture, 1-archiv√©</li></ul></li>
<li><code>cvg</code> : carte de visite du groupe <code>[photo, info]</code> crypt√©e par la cl√© G du groupe.</li>
<li><code>idhg</code> : id du compte h√©bergeur crypt√© par la cl√© G du groupe.</li>
<li><code>v1 v2</code> : volumes courants des secrets du groupe.</li>
<li><code>f1 f2</code> : forfaits v1 v2 attribu√©s par le compte h√©bergeur.</li>
<li><code>mcg</code> : liste des mots cl√©s d√©finis pour le groupe crypt√©e par la cl√© du groupe crypt√©e par la cl√© G du groupe.</li>
<li><code>vsh</code></li>
</ul>

<h2>Table <code>invitgr</code>. Invitation d'un avatar M par un animateur A √† un groupe G</h2>

<p>Un avatar A conna√Æt la liste des groupes dont il est membre par son row avatar qui reprend les identit√©s des groupes crypt√©es par la cl√© K du compte.</p>

<p>Cette liste ne peut √™tre mise √† jour que par l'avatar lui-m√™me : un membre M de G qui souhaite inscrire A comme membre peut certes le faire mais les membres sont identifi√©s relativement au groupe. Tant que A n'a pas inscrit G dans sa liste des groupes, il ne peut pas savoir qu'il a √©t√© invit√©.</p>

<p>Une invitation est un row qui va juste permettre de notifier une session de A qu'il a √©t√© inscrit comme membre d'un groupe :
- elle porte l'id de l'invit√©.
- elle porte un num√©ro d'invitation al√©atoire qui permettra aux animateurs du groupe de <em>r√©silier</em> l'acc√®s de A au groupe en d√©truisant la r√©f√©rence au groupe dans le row avatar de A.
- elle porte le couple <code>nom rnd</code> identifiant le groupe et sa cl√© crypt√© par la cl√© publique de l'avatar.</p>

<p>Dans une session de A d√®s que cette invitation parvient, soit par synchronisation, soit au chargement initial, la session poste une op√©ration de <code>rgularisationGR</code> qui va inscrire dans le row avatar de A le nouveau groupe <code>nom rnd</code> mais crypt√© par la cl√© K du compte de A. Ceci d√©truit l'invitation devenu inutile.</p>

<pre><code>CREATE TABLE "invitgr" (
"id"  INTEGER,
"ni" INTEGER,
"datap" BLOB,
PRIMARY KEY ("id", "ni"));
</code></pre>

<ul>
<li><code>id</code> : id du membre invit√©.</li>
<li><code>ni</code> : hash du num√©ro d'invitation.</li>
<li><code>datap</code> : crypt√© par la cl√© publique du membre invit√©.
<ul><li><code>nom rnd im</code> : nom complet du groupe (donne sa cl√©).</li></ul></li>
</ul>

<h2>Table <code>membre</code> : CP <code>id nm</code>. Membre d'un groupe</h2>

<p>Chaque membre d'un groupe a une entr√©e pour le groupe identifi√©e par son indice de membre <code>im</code>. <br>
L'indice d'un membre M d'id <code>idm</code> dans le groupe G de cl√© <code>cg</code> est le <em>hash sur un entier de l'encryption</em> par <code>cg</code> de <code>idm</code>.</p>

<p>Les donn√©es relatives aux membres sont crypt√©es par la cl√© du groupe.</p>

<p>Table</p>

<pre><code>CREATE TABLE "membre" (
"id"  INTEGER,
"im"    INTEGER,
"v"     INTEGER,
"st"    INTEGER,
"vote"  INTEGER,
"mc"  BLOB,
"infok" BLOB,
"datag" BLOB,
"ardg"  BLOB,
"vsh"   INTEGER,
PRIMARY KEY("id", "im"));
CREATE INDEX "id_v_membre" ON "membre" ( "id", "v" );
CREATE INDEX "st_membre" ON "membre" ( "st" ) WHERE "st" &lt; 0;
</code></pre>

<ul>
<li><code>id</code> : id du groupe.</li>
<li><code>im</code> : num√©ro du membre dans le groupe.</li>
<li><code>v</code> :</li>
<li><code>st</code> : statut. <code>xp</code> : &lt; 0 signifie supprim√©.
<ul><li><code>x</code> : 0:pressenti, 1:invit√©, 2:actif (invitation accept√©e), 3: inactif (invitation refus√©e), 4: inactif (r√©sili√©), 5: inactif (disparu).</li>
<li><code>p</code> : 0:lecteur, 1:auteur, 2:administrateur.</li></ul></li>
<li><code>vote</code> : vote de r√©ouverture.</li>
<li><code>mc</code> : mots cl√©s du membre √† propos du groupe.</li>
<li><code>infok</code> : commentaire du membre √† propos du groupe crypt√© par la cl√© K du membre.</li>
<li><code>datag</code> : donn√©es crypt√©es par la cl√© du groupe. (immuable)
<ul><li><code>nom, rnd</code> : nom complet de l'avatar.</li>
<li><code>ni</code> : num√©ro d'invitation du membre dans <code>invitgr</code>. Permet de supprimer l'invitation et d'effacer le groupe dans son avatar (cl√© de <code>lmbk</code>).</li>
<li><code>idi</code> : id du premier membre qui l'a pressenti / invit√©.</li></ul></li>
<li><code>ardg</code> : ardoise du membre vis √† vis du groupe. Couple <code>[dh, texte]</code> crypt√© par la cl√© du groupe. Contient le texte d'invitation puis la r√©ponse de l'invit√© crypt√©e par la cl√© du groupe. Ensuite l'ardoise peut √™tre √©crite par le membre (actif) et les animateurs.</li>
<li><code>vsh</code></li>
</ul>

<p><strong>Remarques</strong>
- un membre <em>pressenti</em> a un row <code>membre</code> de statut <code>0</code> (l'avatar n'a pas le groupe dans sa liste des groupes).
- un membre <em>invit√©</em> a un row <code>membre</code> de statut <code>1</code> (l'avatar a le groupe dans sa liste des groupes).
- quand un membre <code>invit√©</code> accepte son statut passe √† <code>2</code>.
- les membres de statut <em>invit√©</em> et <em>actif</em> peuvent acc√©der √† la liste des membres et √† leur <em>ardoise</em> (ils ont la cl√© du groupe dans leur row <code>avatar</code>).
- les membres <em>actif</em> acc√®dent aux secrets. En terme de cryptographie, les membres invit√©s <em>pourraient</em> aussi en lecture (ils ont re√ßu la cl√© dans l'invitation) mais le serveur l'interdit.
- les membres des statuts <em>pressenti, ayant refus√©, r√©sili√©, disparu</em> n'ont pas / plus la cl√© du groupe dans leur row <code>avatar</code> (<code>lgrk</code>). <code>infok</code> est null.
- un membre r√©sili√© peut √™tre r√©invit√©, le num√©ro d'invitation <code>ni</code> est r√©utilis√©.</p>

<p>Les animateurs peuvent :
- inviter d'autres avatars √† rejoindre la liste.
- changer les statuts des membres non animateurs.
- d√©truire le groupe.</p>

<p>Un animateur peut lancer un <em>nettoyage</em> pour d√©tecter les membres qui auraient disparus <em>et</em> ne seraient plus cit√©s comme auteur d'aucun secret du groupe.</p>

<p>Le row <code>membre</code> d'un membre subsiste quand il est <em>r√©sili√©</em> ou <em>disparu</em> pour information historique du groupe: sa carte de visite reste accessible quand il est <em>r√©sili√©</em>.</p>

<h2>Secrets</h2>

<p>Un secret est identifi√© par l'id du propri√©taire (avatar ou groupe) et de <code>ns</code> compl√©mentaire al√©atoire (pair pour un secret d'avatar, impair pour un secret de groupe).</p>

<p>La cl√© de cryptage du secret <code>cles</code> est selon le cas :
- (0) <em>secret personnel d'un avatar A</em> : la cl√© K de l'avatar. <code>ic</code> vaut 0.
- (1) <em>secret d'un couple d'avatars A et B</em> : leur cl√© <code>cc</code> de contact fort. <code>ic</code> donne l'indice du contact ce qui permet d'obtenir <code>cc</code> dans la donn√©e de <code>contact</code>.
- (2) <em>secret d'un groupe G</em> : la cl√© du groupe G. <code>ic</code> vaut 0.</p>

<p><strong>Un secret de couple A / B est mat√©rialis√© par 2 secrets de m√™me contenu</strong>
- un pour A et un pour B (et la m√™me cl√© de cryptage, celle <code>cc</code> du couple). 
- chaque secret dans ce cas d√©tient la r√©f√©rence de l'autre afin que la mise √† jour de l'un puisse √™tre r√©percut√©e sur l'autre (quand il existe encore).
- A et B peuvent ind√©pendamment l'un de l'autre d√©truire leur exemplaire : de facto il n'y a plus de copie synchronis√©e de l'autre.
- A cr√©e les deux exemplaires du secret en g√©n√©rant deux num√©ros <code>ns</code> afin que la relation entre A et B n'apparaisse pas dans la base.</p>

<h3>Un secret a toujours un texte et possiblement une pi√®ce jointe</h3>

<p>Le texte a une longueur maximale de 4000 caract√®res. L'aper√ßu d'un secret est constitu√©e des 140 premiers caract√®res de son texte ou moins (premi√®re ligne au plus).</p>

<p><em>Le texte complet d'un secret</em> n'existe que lorsque le texte fait plus de 140 caract√®res : il est stock√© gzipp√©.</p>

<p><strong>La liste des auteurs d'un secret donne les derniers auteurs:</strong>
- dans l'ordre de modification, le plus r√©cent en t√™te,
- sans doublon.</p>

<h3>Pi√®ces jointes</h3>

<p>Un secret <em>peut</em> avoir plusieurs pi√®ces jointes, chacune identifi√©e par : <code>nom.ext|type|dh</code>.
- le <code>nom.ext</code> d'une pi√®ce jointe est un nom de fichier, d'o√π un certain nombre de caract√®res interdits (dont le <code>/</code>). Pour un secret donn√©,ce nom est identifiant.
- <code>type</code> est le MIME type du fichier d'origine.
- <code>dh</code> est la date-heure d'enregistrement de la pi√®ce jointe (pas de cr√©ation ou derni√®re modification de son fichier d'origine).
- un signe <code>$</code> √† la fin indique que le contenu est gzipp√© en stockage.
- le volume de la pi√®ce jointe est le volume NON gzipp√©. Seuls les fichiers de types <code>text/...</code> sont gzipp√©s.</p>

<p>Une pi√®ce jointe d'un nom donn√© peut √™tre mise √† jour / remplac√©e : le nouveau texte peut avoir un type diff√©rent et aura par principe une date-heure diff√©rente.</p>

<blockquote>
  <p><strong>Le contenu d'une pi√®ce jointe sur stockage externe est crypt√© par la cl√© du secret.</strong></p>
</blockquote>

<h3>Mise √† jour d'un secret</h3>

<p>Le droit de mise √† jour d'un secret est contr√¥l√© par le couple <code>p x</code> :
- <code>p</code> indique si le texte est prot√©g√© contre l'√©criture ou non.
- <code>x</code> indique quel avatar a l'exclusivit√© d'√©criture et le droit de basculer la protection :
  - pour un secret personnel, x est implicitement l'avatar d√©tenteur du secret.
  - pour un secret de couple, 1 d√©signe celui des deux contacts du couple ayant l'id le plus bas, 2 d√©signe l'autre.
  - pour un secret de groupe, x est l'indice du membre.</p>

<p>Celui ayant l'exclusivit√© peut d√©cider :
- de prot√©ger le secret contre l'√©criture (se l'interdire √† lui-m√™me),
- de lever cette protection (se l'autoriser √† lui-m√™me),
- de transf√©rer l'exclusivit√© √† un autre membre,
- de supprimer l'exclusivit√©.</p>

<p>Un animateur a ces m√™mes droits.</p>

<h3>Secret temporaire et permanent</h3>

<p>Par d√©faut √† sa cr√©ation un secret est <em>temporaire</em> :
- son <code>st</code> contient la <em>date limite de validit√©</em> indiquant qu'il sera automatiquement d√©truit √† cette √©ch√©ance.
- un secret temporaire peut √™tre prolong√©, tout en restant temporaire.
- un avatar Ai qui le partage peut le d√©clarer <em>permanent</em>, le secret ne sera plus d√©truit automatiquement et par convention son <code>st</code> est √©gal √† <code>99999</code>:
  - l'avatar propri√©taire pour un secret personnel.
  - les deux avatars pour un secret de couple.
  - un des animateurs pour un secret de groupe.</p>

<h3>Secrets voisins</h3>

<p>Les secrets peuvent √™tre regroup√©s par <em>voisinage</em> autour d'un secret de r√©f√©rence : ceci permet de voir ensemble facilement les secrets parlant d'un m√™me sujet pr√©cis ou correspondant √† une conversation.
- <strong>un secret voisin d'un secret de r√©f√©rence</strong> contient sa r√©f√©rence (id et num√©ro de secret) ; celle-ci est immuable, donn√©e √† la cr√©ation.
- <strong>un secret de r√©f√©rence n'a pas lui-m√™me de r√©f√©rence</strong> : ce sont ses voisins qui le r√©f√©renceront.
- si B est un secret voisin de A (r√©f√©ren√ßant A), on peut cr√©er C voisin de B mais en fait C portera la r√©f√©rence de A (pas de B).
- rien n'emp√™che ainsi indirectement de rajouter des voisins √† un secret disparu.
- un avatar peut ainsi avoir des secrets voisins d'un secret de r√©f√©rence auquel il ne peut pas acc√©der (et qui peut-√™tre n'existe plus), la grande famille des voisins peut ainsi s'√©tendre loin. </p>

<h2>Table <code>secret</code> : CP <code>id ns</code>. Secret</h2>

<pre><code>CREATE TABLE "secret" (
"id"  INTEGER,
"ns"  INTEGER,
"ic"  INTEGER,
"v" INTEGER,
"st"  INTEGER,
"ora" INTEGER,
"v1"  INTEGER,
"v2"  INTEGER,
"mc"   BLOB,
"txts"  BLOB,
"mpjs"  BLOB,
"dups"  BLOB,
"refs"  BLOB,
"vsh" INTEGER,
PRIMARY KEY("id", "ns");
CREATE INDEX "id_v_secret" ON "secret" ("id", "v");
CREATE INDEX "st_secret" ON "secret" ( "st" ) WHERE "st" &lt; 0;
</code></pre>

<ul>
<li><code>id</code> : id du groupe ou de l'avatar.</li>
<li><code>ns</code> : num√©ro du secret.</li>
<li><code>ic</code> : indice du contact pour un secret de couple, sinon 0.</li>
<li><code>v</code> :</li>
<li><code>st</code> :
<ul><li>&lt; 0 pour un secret <em>supprim√©</em>.</li>
<li><code>99999</code> pour un <em>permanent</em>.</li>
<li><code>dlv</code> pour un <em>temporaire</em>.</li></ul></li>
<li><code>ora</code> : <em>xxxxxp</em> (<code>p</code> reste de la division par 10)
<ul><li><code>p</code> : 0: pas prot√©g√©, 1: prot√©g√© en √©criture.</li>
<li><code>xxxxx</code> : exclusivit√© : l'√©criture et la gestion de la protection d'√©criture sont restreintes au membre du groupe dont <code>im</code> est <code>x</code> (un animateur a toujours le droit de gestion de protection et de changement du <code>x</code>). Pour un secret de couple : 1 d√©signe celui des deux contacts du couple ayant l'id le plus bas, 2 d√©signe l'autre.</li></ul></li>
<li><code>v1</code> : volume du texte</li>
<li><code>v2</code> : volume de la pi√®ce jointe</li>
<li><code>mc</code> : 
<ul><li>secret personnel ou de couple : vecteur des index de mots cl√©s.</li>
<li>secret de groupe : map s√©rialis√©e,</li>
<li><em>cl√©</em> : <code>im</code> de l'auteur (0 pour les mots cl√©s du groupe),</li>
<li><em>valeur</em> : vecteur des index des mots cl√©s attribu√©s par le membre.</li></ul></li>
<li><code>txts</code> : crypt√© par la cl√© du secret.
<ul><li><code>d</code> : date-heure de derni√®re modification du texte</li>
<li><code>l</code> : liste des auteurs (pour un secret de couple ou de groupe).</li>
<li><code>t</code> : texte gzipp√© ou non</li></ul></li>
<li><code>mpjs</code> : s√©rialisation de la map des pi√®ces jointes.</li>
<li><code>dups</code> : couple <code>[id, ns]</code> crypt√© par la cl√© du secret de l'autre exemplaire pour un secret de couple A/B.</li>
<li><code>refs</code> : couple <code>[id, ns]</code> crypt√© par la cl√© du secret r√©f√©ren√ßant un autre secret (r√©f√©rence de voisinage qui par principe, lui, n'aura pas de <code>refs</code>).</li>
<li><code>vsh</code></li>
</ul>

<p><strong>Suppression d'un secret :</strong>
<code>st</code> est mis en n√©gatif : les sessions synchronis√©es suppriment d'elles-m√™mes ces secrets en local avant <code>st</code> si elles elles se synchronise avant <code>st</code>, sinon √ßa sera fait √† <code>st</code>.</p>

<p><strong>Map des pi√®ces jointes :</strong>
- <em>cl√©</em> : hash (court) de <code>nom.ext</code> en base64 URL. Permet d'effectuer des remplacements par une version ult√©rieure.
- <em>valeur</em> : <code>[idc, taille]</code>
  - <code>idc</code> : id compl√®te de la pi√®ce jointe (<code>nom.ext|type|dh$</code>), crypt√©e par la cl√© du secret et en base64 URL.
  - <code>taille</code> : en bytes, avant gzip √©ventuel.</p>

<p><strong>Identifiant de stockage :</strong> <code>org/sid@sns/cle@idc</code> <br>
- <code>org</code> : code de l'organisation.
- <code>sid</code> : id du secret en base64 URL. Pour un secret de couple <code>id ns</code> est par convvention celui de l'id la plus faible du couple (la pi√®ce jointe n'est pas d√©doubl√©e contrairement au secret lui-m√™me).
- <code>sns</code> : ns du secret en base64 URL.
- <code>cle</code> : hash court en base64 URL de nom.ext
- <code>idc</code> : id compl√®te de la pi√®ce jointe, crypt√©e par la cl√© du secret et en base64 URL.</p>

<p>En imaginant un stockage sur file system, il y a un r√©pertoire par secret : dans ce r√©pertoire pour une valeur donn√©e de cle@ il n'y a qu'un fichier. Le suffixe <code>idc</code> permet de g√©rer les √©tats interm√©diaires lors d'un changement de version).</p>

<p><em>Une nouvelle version</em> d'une pi√®ce jointe est stock√©e sur support externe <strong>avant</strong> d'√™tre enregistr√©e dans son secret.
- <em>l'ancienne version</em> est supprim√©e du support externe <strong>apr√®s</strong> enregistrement dans le secret.
- les versions cr√©es par anticipation et non valid√©es dans un secret comme celles qui n'ont pas √©t√© supprim√©es apr√®s validation du secret, peuvent √™tre retrouv√©es par un traitement p√©riodique de purge qui peut s'ex√©cuter en ignorant les noms et date-heures r√©elles des fichiers scann√©s.</p>

<h2>Mots cl√©s, principes et gestion</h2>

<p>Les mots cl√©s sont utilis√©s pour :
- filtrer / caract√©riser √† l'affichage les <strong>contacts</strong> d'un compte.
- filtrer / caract√©riser √† l'affichage les <strong>groupes</strong> acc√©d√©s par un compte.
- filtrer / caract√©riser √† l'affichage les <strong>secrets</strong>, personnels, partag√©s avec un contact ou d'un groupe.</p>

<h3>Mots cl√©s : index, cat√©gorie, nom</h3>

<p>Un mot cl√© a un <strong>index</strong> et un <strong>nom</strong> :
- <strong>l'index</strong> (repr√©sent√© sur un octet) identifie le mot cl√© et qui l'a d√©fini :
  - un index de 1 √† 99 est un mot cl√© personnel d'un compte.
  - un index de 100 √† 199 est un mot cl√© d√©fini pour un groupe.
  - un index de 200 √† 255 est un mot cl√© d√©fini par l'organisation et enregistr√© dans sa configuration (donc peu modifiable).
- <strong>le nom</strong> est un texte unique dans l'ensemble des mots cl√©s du d√©finissant : deux mots cl√©s d'un compte, d'un groupe ou de l'organisation ne peuvent pas avoir un m√™me nom. 
  - le nom est court et peut contenir des caract√®res √©mojis en particulier comme premier caract√®re.
  - l'affichage <em>r√©duit</em> ne montre que le premier caract√®re si c'est un √©moji, sinon les deux premiers.</p>

<h4>Cat√©gories de mots cl√©s</h4>

<p>Afin de faciliter leur attribution, un mot cl√© a une <em>cat√©gorie</em> qui permet de les regrouper par finalit√© :
- la cat√©gorie est un mot court commen√ßant par une majuscule : par exemple <em>Statut</em>, <em>Th√®me</em>, <em>Projet</em>, <em>Section</em>
- la cat√©gorie ne fait pas partie du nom : elle est donn√©e √† la d√©finition / mise √† jour du mot cl√© mais est externe.
- il n'y a pas de cat√©gories pr√©d√©finies.
- la cat√©gorie sert pour s√©lectionner des mots cl√©s √† attacher √† son objet et √† l'affichage pour choisir plus facilement un mot cl√© pour filtre selon leur usage / signification.</p>

<h4>Liste de mots cl√©s</h4>

<p>C'est la liste de leurs index, pas de leurs noms : il est ainsi possible de corriger le nom d'un mot cl√© et toutes ses r√©f√©rences s'afficheront avec le nouveau nom rectifi√©.
- un index n'est pr√©sent qu'une fois.
- l'ordre n'a pas d'importance.
- les mots cl√©s d'index 1 √† 99 sont toujours ceux du compte qui les regardent. 
- ceux d'index de 200 √† 255 sont toujours ceux de l'organisation.
- ceux d'index de 100 √† 199 ne peuvent √™tre attach√©s qu'√† un secret de groupe, leur signification est interpr√©t√©e vis √† vis du groupe d√©tenteur du secret.</p>

<blockquote>
  <p>Remarque : deux mots cl√© d'un compte et d'un groupe peuvent porter le m√™me nom (voire d'ailleurs un mot cl√© de l'organisation). L'origine du mot cl√© est distingu√©e √† l'affichage en lisant son code.</p>
</blockquote>

<h4>Mots cl√©s <em>obsol√®tes</em></h4>

<p>Un mot cl√© <em>obsol√®te</em> est un mot cl√© sans cat√©gorie :
- son attribution est interdite : quand une liste de mots cl√©s est √©dit√©e, les mots cl√©s obsol√®tes sont effac√©s.
- la suppression d√©finitive d'un mot cl√© ne s'op√®re que sur un mot cl√© obsol√®te. Une recherche permettra de lister o√π il appara√Æt avant de d√©cider.</p>

<h3>Pr√©sence des listes de mots cl√©s</h3>

<ul>
<li>sur un <strong>contact</strong> d'un avatar du compte : la liste est accompagn√©e d'un court texte de commentaire.</li>
<li>sur <strong>l'invitation</strong> √† un groupe d'un des avatars du compte : la liste est accompagn√©e d'un court texte de commentaire.</li>
<li>sur un <strong>secret</strong>. La propri√©t√© mc contient un objet de structure diff√©rente selon le type de secret.</li>
</ul>

<p><strong>Secret personnel</strong> <br>
<code>mc</code> est un vecteur d'index de mots cl√©s. Les index sont ceux du compte et de l'organisation.</p>

<p><strong>Secret de couple</strong>
<code>mc</code> est le vecteur d'index de mots cl√©s. Les index sont ceux du compte et de l'organisation.</p>

<p><strong>Secret de groupe</strong>
<code>mc</code> est une map :
- <em>cl√©</em> : im, indice du membre dans le groupe. Par convention 0 d√©signe le groupe lui-m√™me.
- <em>valeur</em> : vecteur d'index de secrets. Les index sont ceux personnels du membre, ceux du groupe, ceux de l'organisation.</p>

<p>A l'affichage un membre du groupe peut voir ce que chaque membre √† indiquer comme mots cl√©s. Mais, les index personnels des autres (de 1 √† 99) √©tant ininterpr√©tables ne sont pas affich√©s.</p>

<p>Pour utilisation pour filtrer une liste de secrets dans un groupe :
- si le compte a lui-m√™me donn√© une liste de mots cl√©s, c'est celle-ci qui est prise, sans consid√©rer les mots cl√©s du groupe.
- sinon ce sont les mots cl√©s du groupe.
- ainsi le groupe peut avoir indiqu√© que le secret est <em>nouveau</em> et <em>important</em>, mais si le compte A a indiqu√© que le secret est <em>lu</em> et <em>sans int√©r√™t</em> c'est ceci qui sera utilis√© pour filtrer les listes.</p>

<h1>Gestion des disparitions</h1>

<p>Les ouvertures de session <em>signent</em> dans les tables <code>compta avatar groupe</code>, colonne <code>dds</code>, les rows relatifs aux compte, avatars du compte et groupes acc√©d√©s par le compte.</p>

<p>Une disparition est d√©tect√©e d√®s lors que le GC quotidien d√©tecte des <code>dds</code> trop vieilles.</p>

<h2>Disparition des comptes</h2>

<p>La d√©tection par <code>dds</code> trop ancienne d'un <strong>compte</strong> d√©truit son row dans <code>compte compta prefs</code>.</p>

<p>Un compte est toujours d√©truit physiquement avant ses avatars puisqu'il appara√Æt plus ancien que ses avatars dans l'ordre des signatures.</p>

<p>Le compte n'√©tant plus accessible, ses avatars ne seront plus sign√©s ni les groupes auxquels il acc√©dait.</p>

<h2>Disparition des groupes</h2>

<p>Par construction s'il avait exist√© encore un avatar dont l'acc√®s au groupe n'est pas r√©sili√©, le groupe aurait √©t√© sign√© lors de la connexion du compte de cet avatar : un groupe de signature ancienne n'est donc par principe plus r√©f√©renc√©.</p>

<p>La d√©tection par <code>dds</code> trop ancienne d'un <strong>groupe</strong> d√©truit ses rows dans les tables <code>groupe membre secret</code>.</p>

<p><em>Remarque</em> : quand le dernier avatar ayant acc√®s √† un groupe <em>dispara√Æt</em>, le groupe va finir par dispara√Ætre faute de ne plus √™tre sign√©. Les donn√©es vont finir par √™tre purg√©es, mais √ßa va prendre du temps. Avec la r√©siliation explicitement demand√©e (suppression du groupe), c'est diff√©rent : la purge des donn√©es ci-dessus peut √™tre imm√©diate.</p>

<h2>Disparition des avatars</h2>

<p>La d√©tection s'effectue par le GC quotidien sur recherche des <code>dds</code> trop ancienne dans la table <code>avatar</code>.</p>

<p>Par principe un avatar est d√©tect√© disparu apr√®s la d√©tection de la disparition de son compte. Il s'agit donc de purger les donn√©es.</p>

<h3>Purge des donn√©es identifi√©es par l'id de l'avatar</h3>

<ul>
<li>destruction des rows les tables <code>avrsa avatar contact invitgr parrain rencontre secret</code>.</li>
</ul>

<p>D√®s cet instant le volume occup√© est r√©cup√©r√©.</p>

<h3>Mise √† jour des r√©f√©rences chez les autres comptes</h3>

<p>Un avatar <em>disparu</em> D reste toutefois encore <em>r√©f√©renc√©</em> dans des rows :
- <code>parrain rencontre invitgr</code> : la date limite de validit√© a d√©j√† r√©solu la question, les rows ont <em>d√©j√†</em> √©t√© d√©truits.
- <code>contact</code> : autres avatars l'ayant en contact.
- <code>membre</code> : groupes l'ayant pour membre.  </p>

<h4>contacts</h4>

<p>Quand une session d'un avatar A synchronise les cartes de visite elle a connaissance par la carte de visite de D que cet avatar a disparu : le row <code>contact</code> correspondant a son statut mis √† jour (disparu). </p>

<p>Il n'y a pas de raisons pour que les secrets partag√©s avec D (et d√©doubl√©s) disparaissent aussi.</p>

<p>Le row contact garde une trace historique mais sur demande du compte, un contact <em>disparu</em> peut √™tre <em>oubli√©</em> :
- le row <code>contact</code> a un statut supprim√© (<code>st</code> &lt; 0).
- tous les <code>secret</code> de l'avatar portant ce num√©ro de contact sont d√©truits.</p>

<h4>membres</h4>

<p>Pour chaque groupe acc√©d√© par l'avatar :
- le row <code>membre</code> de D (s'il existe) a son statut mis √† jour √† <em>disparu</em>. 
- sur demande d'un compte animateur du groupe, le row pourrait √™tre marqu√© <em>supprim√©</em> pour <em>nettoyer</em> la liste des membres : mais des secrets du groupe peuvent continuer √† r√©f√©rencer ce membre comme auteur. Ne pas nettoyer dans ce cas ?</p>

<p>Dans la session la carte de visite est supprim√©e, elle ne sera plus synchronis√©e.</p>

<p>Les r√©f√©rences peuvent mettre longtemps a √™tre mises √† jour, tous les comptes r√©f√©ren√ßant l'avatar D ayant √† √™tre ouverts (ou disparaissant eux-m√™mes).</p>

<h2>Secrets de couple A / B</h2>

<h3>A et B acceptent le partage de secrets</h3>

<p>Les volumes sont d√©compt√©s sur A et sur sur B, pour v1 comme pour v2, justement parce qu'ils peuvent en toute ind√©pendance d√©truire leur exemplaire.</p>

<p>On sait chez A que B a d√©truit son exemplaire (sur <code>ora</code> xx vaut 0, 1 ou 2. 3 signifiant exemplaire unique, donc exclusivit√© au restant.</p>

<p>Si B <strong>d√©truit</strong> son exemplaire :
- A continue √† agir sur le sien comme il l'entend : il retrouve de facto une exclusivit√© qu'il n'avait peut-√™tre pas. De toutes les fa√ßons B n'a plus de moyens de s'en plaindre, il a abandonn√© le secret.
- B r√©cup√®re du volume v1 / v2.</p>

<h3>B n'accepte plus le partage de secrets</h3>

<p>... mais √ßa <em>pourrait</em> revenir.
- le secret est gel√®, aucune mise √† jour ni de texte ni de pi√®ces jointes.
- changement d'exclusivit√© / protection impossible.
- seuls les mots-cl√©s de chacun peuvent changer afin de pouvoir les filtrer en s√©lection.</p>

<p>Le secret ne redevient normal que si les A et B acceptent le partage de secrets.</p>
